<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åæ’ç‰©æµç«™å°ç›‘æ§</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/style.css" />
</head>
<body>
<div class="container py-4">
    <div class="text-center mb-5">
        <h1 class="fw-bold">ğŸšš åæ’ç‰©æµç«™å°ç›‘æ§ä»ªè¡¨ç›˜ ğŸšš</h1>
        <p class="text-muted">å®æ—¶å±•ç¤º 40ä¸ªç«™å° PLC æ•°æ®ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰</p>
        <div class="row text-center">
            <div class="col-md-3">
                <small class="text-info">ğŸ“ æ¯ç«™å°10å­—èŠ‚ç»“æ„</small>
            </div>
            <div class="col-md-3">
                <small class="text-info">ğŸ”¢ 6ä¸ªæ•°æ®å­—æ®µ</small>
            </div>
            <div class="col-md-3">
                <small class="text-info">ğŸ¯ ç¬¬40ç«™å°åç§»é‡390</small>
            </div>
            <div class="col-md-3">
                <small class="text-info">ğŸ“Š åŒ…å«2ä¸ªå¤‡ç”¨å­—æ®µ</small>
            </div>
        </div>
    </div>
    <table class="table table-bordered table-hover table-striped align-middle" id="station-table">
        <thead class="table-primary text-center">
        <tr>
            <th>åºå·</th>
            <th>ç«™å°åç§°</th>
            <th>åç§»é‡</th>
            <th>Occupied</th>
            <th>CallStation</th>
            <th>Type</th>
            <th>OldStation</th>
            <th>æ›´æ–°æ—¶é—´</th>
        </tr>
        </thead>
        <tbody class="text-center"></tbody>
    </table>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const tbody = document.querySelector('#station-table tbody');
let snapshot = {};
function badge(val, type){
  if(type==='Occupied') return `<span class="badge ${val? 'badge-yes':'badge-no'}">${val?'æœ‰è´§':'ç©º'}</span>`;
  if(type==='CallStation') return `<span class="badge ${val? 'badge-call':'badge-no'}">${val?'å‘¼å«':'æ— '}</span>`;
  return val;
}

// è®¡ç®—ç«™å°åç§»é‡
function calculateOffset(index) {
  return index * 10;
}

function render(list){
  const now = new Date();
  // è¿‡æ»¤åªæ˜¾ç¤º0-39èŒƒå›´å†…çš„ç«™å°
  const filteredList = list.filter(item => item.index >= 0 && item.index < 40);
  filteredList.sort((a,b)=>a.index-b.index).forEach(item=>{
    let tr = tbody.querySelector(`tr[data-idx='${item.index}']`);
    const isNew = !tr;
    if(isNew){
      tr = document.createElement('tr');
      tr.setAttribute('data-idx', item.index);
      tbody.appendChild(tr);
    }
    const offset = calculateOffset(item.index);
    const stationName = item.stationName || `${item.index + 1}å·ç«™å°`;
    const html = `
      <td class="fw-bold">${item.index}</td>
      <td><span class="badge bg-info text-dark" style="font-size: 0.75rem;">${stationName}</span></td>
      <td><small class="text-info">${offset}</small></td>
      <td>${badge(item.Occupied,'Occupied')}</td>
      <td>${badge(item.CallStation,'CallStation')}</td>
      <td>${item.Type}</td>
      <td>${item.OldStation}</td>
      <td><small>${now.toLocaleTimeString()}</small></td>`;
    if(tr.innerHTML!==html){
      tr.innerHTML = html;
      tr.classList.add('fade-highlight');
      setTimeout(()=>tr.classList.remove('fade-highlight'),2000);
    }
  });
}

socket.on('update', render);
</script>
</body>
</html>
